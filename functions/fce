#!/usr/bin/env nu
# fce - Forge Content search â†’ Editor
# Universal content discovery with editor opening
# Part of nushell-knowledge-tools v2.0

def main [] {
    if not ($env.FORGE? | is-empty) and ($env.FORGE | path exists) {
        let query = (input "ğŸ” Search content: ")
        if ($query | is-empty) {
            return
        }

        print $"ğŸ” Searching for: ($query)"
        let results = try {
            ^rg -i --type md -l $query $env.FORGE | lines | where $it != ""
        } catch {
            print "âŒ Content search failed. Install ripgrep: brew install ripgrep"
            return
        }

        if ($results | is-empty) {
            print "âŒ No matches found"
            return
        }

        let selected = ($results | str join "\n" | ^env TERM=xterm-256color TERMINFO="" TERMINFO_DIRS="" sk --preview $"rg --color=always -i -C 3 '($query)' {}" --preview-window 'right:60%' --bind 'up:up,down:down,ctrl-j:down,ctrl-k:up' --prompt "ğŸ“„ Content: " | str trim)
        if not ($selected | is-empty) {
            # Use $env.EDITOR with graceful fallback
            let editor = if (not ($env.EDITOR? | is-empty)) {
                $env.EDITOR
            } else {
                "vi"
            }

            print $"ğŸš€ Opening ($selected | path basename) in ($editor)..."
            ^$editor $selected
        }
    } else {
        print "âŒ FORGE not set or doesn't exist"
        print "ğŸ’¡ Set with: $env.FORGE = '/path/to/your/knowledge-base'"
    }
}
